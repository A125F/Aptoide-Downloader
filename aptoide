#!/bin/bash
### Aptoide Downloader v2

echo -e "\e[1m\e[93mAptoide Downloader\e[0m
\e[1mCopyright (C) 2012-2019 Cristian Stefanescu\e[0m
This program comes with ABSOLUTELY NO WARRANTY;
This is free software, and you are welcome to redistribute it
under certain conditions;  for details see LICENCE
or visit http://www.gnu.org/licenses/
\e[1mContributors:
https://github.com/bastei
https://github.com/mfonville\e[0m"


### some variables we somehow need
### get page as html, use either arg1 or read from stdin
if [ "$#" -eq 1 ]; then
    URL=$1
else
    echo -e "\n\nInsert Aptoide URL:"
    read link
    URL=$link
fi
### Use the name in the URL to get the filename
APK=$( echo $URL | sed 's,.*://,,g;s,..[a-zA-Z].aptoide.com.,,' )
### Use a temporary file
TEMP_PAGE=$( mktemp )

### Download the HTML source page
wget -q $URL -O $TEMP_PAGE

### Extract the apk link from the page
LINK=$(grep data-mobile-download $TEMP_PAGE  | sed 's/.*="//g;s/.$//g')

### Download the final link
### aptoide.sh will download the apk in ~/Downloads or ~ if ~/Downloads is not accesible
if [ -w "$( xdg-user-dir DOWNLOAD )" ]; then
    aptoide_home_dir="$( xdg-user-dir DOWNLOAD )"
else
    aptoide_home_dir="$HOME"
fi
wget -q --show-progress $LINK -O $aptoide_home_dir/$APK.apk

### Cleanup the temporary file
rm $TEMP_PAGE
